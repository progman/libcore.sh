#!/bin/bash
#---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
# 0.0.1
# Alexey Potehin <gnuplanet@gmail.com>, http://www.gnuplanet.ru/doc/cv
#---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
# check depends
function check_prog()
{
	for i in ${1};
	do
		if [ "$(command -v ${i})" == "" ];
		then
			echo "FATAL: you must install \"${i}\"...";
			return 1;
		fi
	done

	return 0;
}
#---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
function resolv()
{
	touch /etc/resolv.conf &> /dev/null < /dev/null;


	if [ "$(cat /etc/resolv.conf | grep ${1} | wc -l  | { read a b; echo ${a}; })" != "0" ];
	then
		echo "/etc/resolv.conf has ${1}";
		return 0;
	fi
	echo "/etc/resolv.conf will have ${1}";


	local LOCAL_TMPDIR="/tmp";
	if [ "${TMPDIR}" != "" ] && [ -d "${TMPDIR}" ];
	then
		LOCAL_TMPDIR="${TMPDIR}";
	fi
	local TMP="${LOCAL_TMPDIR}/resolv.conf";


	echo "nameserver ${1}" > "${TMP}";
	cat /etc/resolv.conf >> "${TMP}";
	sync;


	mv "${TMP}" /etc/resolv.conf &> /dev/null < /dev/null;
	if [ "${?}" != "0" ];
	then
		echo "can't mv tmp file";
		return 1;
	fi
	sync;


	chown root:root /etc/resolv.conf &> /dev/null < /dev/null;
	if [ "${?}" != "0" ];
	then
		echo "can't chown /etc/resolv.conf";
		return 1;
	fi
	chmod 0644 /etc/resolv.conf &> /dev/null < /dev/null;
	if [ "${?}" != "0" ];
	then
		echo "can't chmod /etc/resolv.conf";
		return 1;
	fi
	sync;


	return 0;
}
#---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
# general function
function main()
{
# check depends tools
	check_prog "cat chmod chown echo grep mv sync touch wc";
	if [ "${?}" != "0" ];
	then
		return 1;
	fi


	resolv "8.8.8.8";
	resolv "1.1.1.1";


	return "${?}";
}
#---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
main "${@}";

exit "${?}";
#---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
