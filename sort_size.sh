#!/bin/bash
#---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
# 0.0.4
# Alexey Potehin <gnuplanet@gmail.com>, http://www.gnuplanet.ru/doc/cv
#---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
# example:
# $ echo '11'  > 2;
# $ echo '111' > 3;
# $ echo '1'   > 1;
# $ echo -e "2\n3\n1" | sort_size.sh
# 1
# 2
# 3
#---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
# check depends
function check_prog()
{
	for i in ${1};
	do
		if [ "$(command -v ${i})" == "" ];
		then
			echo "FATAL: you must install \"${i}\"...";
			return 1;
		fi
	done

	return 0;
}
#---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
# view help
function help()
{
	echo "example: cat FILELIST | ${0} [-r]";
}
#---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
# general function
function main()
{
	if [ "${1}" == "--help" ] || [ "${1}" == "-help" ] || [ "${1}" == "-h" ];
	then
		help;
		return 1;
	fi


# check depends tools
	check_prog "echo grep wc stat sort";
	if [ "${?}" != "0" ];
	then
		return 1;
	fi


# check reverse option
	local REVERSE='';
	if [ "${1}" == "-r" ];
	then
		REVERSE='-r';
	fi


# get CPU count
	local CPU_COUNT=$(grep processor /proc/cpuinfo | wc -l);


# read filename, get file size, sort list, print filename
	while read -r FILENAME;
	do
		local SIZE;
		SIZE=$(stat --printf='%s' -L -- "${FILENAME}" 2> /dev/null);
		if [ "${?}" == "0" ];
		then
			echo "${SIZE} ${FILENAME}";
		fi
	done | sort -n ${REVERSE} --parallel=${CPU_COUNT} |
	{
		while read -r SIZE FILENAME;
		do
			echo "${FILENAME}";
		done
	};


	return 0;
}
#---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
main "${@}";

exit "${?}";
#---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
